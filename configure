#!/bin/sh

CONFIG=${CONFIG:-config.mk}

VERSION=$(cat Cargo.toml | grep -e '^version = ' | sed -E 's/.*"([^"]+)".*/\1/')
REVISION=0

PREFIX=/usr/local
LIBDIR=
INCLUDEDIR=
PKGCONFIGDIR=

DEB_NAME=quantizr

DEBUG=0
IMAGEQUANT_COMPAT=0

for i in "$@"; do
  case $i in
  --help|-h)
    echo "
    --debug                              Build in debug mode
    --enable-imagequant-compatibility    Enable partial compatibility with libimagequant API

    --prefix=<dir>                       Installation directory [$PREFIX]
    --libdir=<dir>                       Libraries installation directory [\$prefix/lib]
    --includedir=<dir>                   Header files installation directory [\$prefix/include]
    --pkgconfigdir=<dir>                 pkg-config file installation directory [\$prefix/lib/pkgconfig]

    --deb-name=<name>                    Name of deb-package
    --revision=<revision>                Revision of deb-package
    "
    exit 0
    ;;
  --debug)
    DEBUG=1
    ;;
  --enable-imagequant-compatibility)
    IMAGEQUANT_COMPAT=1
    ;;
  --prefix=*)
    PREFIX=${i#*=}
    ;;
  --libdir=*)
    LIBDIR=${i#*=}
    ;;
  --includedir=*)
    INCLUDEDIR=${i#*=}
    ;;
  --pkgconfigdir=*)
    PKGCONFIGDIR=${i#*=}
    ;;
  --deb-name=*)
    DEB_NAME=${i#*=}
    ;;
  --revision=*)
    REVISION=${i#*=}
    ;;
  *)
    echo "Unknown argument $i. See $0 --help for the available ones"
    exit 1
    ;;
  esac
done

echo "
# Generated by configure script
VERSION := $VERSION
PREFIX := $PREFIX
LIBDIR := ${LIBDIR:-$PREFIX/lib}
INCLUDEDIR := ${INCLUDEDIR:-$PREFIX/include}
PKGCONFIGDIR := ${PKGCONFIGDIR:-$PREFIX/lib/pkgconfig}
DEB_NAME := $DEB_NAME
DEB_VERSION := $VERSION-$REVISION
DEBUG := $DEBUG
IMAGEQUANT_COMPAT := $IMAGEQUANT_COMPAT
" > $CONFIG
